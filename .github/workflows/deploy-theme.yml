name: Deploy Keycloak Theme

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy theme to VPS and Keycloak container
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e

            echo "ðŸ§¹ Limpando pasta tema-keycloak"
            rm -rf ~/tema-keycloak/*
            mkdir -p ~/tema-keycloak

            echo "â¬‡ï¸ Clonando branch main"
            cd ~
            git clone -b main https://github.com/SEU_USUARIO/SEU_REPO.git tema-keycloak

            echo "ðŸ“¦ Copiando tema para container do Keycloak"
            docker cp \
              ~/tema-keycloak/themes/dexcode \
              keycloak-yswkooow0ck448kss04o0wcg:/opt/keycloak/themes

            echo "ðŸ” Ajustando permissÃµes"
            docker exec keycloak-yswkooow0ck448kss04o0wcg \
              chown -R 1000:1000 /opt/keycloak/themes/dexcode

            echo "â™»ï¸ Reiniciando Keycloak"
            docker restart keycloak-yswkooow0ck448kss04o0wcg

            echo "âœ… Deploy finalizado com sucesso"
          EOF
